<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TikTok API Playground</title>
  <style>
    :root {
      --bg: #f7f7f7;
      --panel: #ffffff;
      --accent: #f97316;
      --accent-2: #fb923c;
      --text: #0f172a;
      --muted: #6b7280;
      --border: #e5e7eb;
      --mono: "JetBrains Mono", "SFMono-Regular", Consolas, monospace;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
      font-family: "Inter", "Segoe UI", "Helvetica Neue", system-ui, -apple-system, sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    h1 { margin: 0 0 8px; font-size: 26px; letter-spacing: -0.4px; }
    p { margin: 4px 0 12px; color: var(--muted); }
    .shell {
      display: grid;
      grid-template-columns: 260px 1fr;
      gap: 0;
      min-height: calc(100vh - 48px);
    }
    .sidebar {
      background: #fff7ed;
      border-right: 1px solid #fed7aa;
      padding: 16px;
      overflow-y: auto;
    }
    .content {
      padding: 24px;
      background: var(--bg);
    }
    .grid { display: grid; gap: 14px; }
    .two { grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 18px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
    }
    label { display: block; font-weight: 600; margin-bottom: 6px; }
    input, select, textarea, button {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text);
      font-size: 14px;
      font-family: inherit;
      transition: border 0.2s, box-shadow 0.2s, transform 0.1s;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.2);
    }
    button {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      border: none;
      color: #fff7ed;
      font-weight: 700;
      cursor: pointer;
    }
    button:hover { transform: translateY(-1px); }
    button:active { transform: translateY(0); }
    .row { display: flex; gap: 10px; align-items: center; }
    .row > *:first-child { flex: 0 0 auto; }
    .row > *:last-child { flex: 1; }
    .pill {
      padding: 4px 8px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 12px;
      background: rgba(249, 115, 22, 0.12);
      color: var(--accent);
      border: 1px solid rgba(249, 115, 22, 0.35);
    }
    .muted { color: var(--muted); font-size: 13px; }
    .field { margin-bottom: 12px; }
    pre {
      background: #f8fafc;
      border-radius: 10px;
      padding: 12px;
      white-space: pre-wrap;
      word-break: break-word;
      border: 1px solid var(--border);
      font-family: var(--mono);
      font-size: 13px;
      margin: 0;
    }
    .section-title { margin: 0 0 10px; font-size: 16px; }
    .response-meta { font-size: 13px; color: var(--muted); margin: 0 0 6px; }
    .hint { font-size: 13px; color: var(--muted); }
    .nav-item {
      padding: 10px 12px;
      border-radius: 10px;
      cursor: pointer;
      margin-bottom: 8px;
      background: transparent;
      color: #9a3412;
      border: 1px solid transparent;
      transition: all 0.15s;
      font-weight: 600;
    }
    .nav-item:hover {
      background: #fff1e6;
      border-color: #fed7aa;
    }
    .nav-item.active {
      background: #f97316;
      color: #fff;
      border-color: #f97316;
      box-shadow: 0 6px 16px rgba(249, 115, 22, 0.25);
    }
  </style>
</head>
<body>
  <div class="shell">
    <aside class="sidebar">
      <h2 style="margin:0 0 12px;font-size:18px;">API Menu</h2>
      <div id="operationList"></div>
    </aside>

    <main class="content">
      <h1>TikTok API Playground</h1>
      <p>Fill params, send, and preview cURL. Base URL defaults to your gateway.</p>

      <div class="panel grid">
        <div class="grid two">
          <div>
            <label>Base URL</label>
            <input id="baseUrl" placeholder="http://your-ip:10001/douyin" value="">
            <div class="hint">You can point to ECS IP or domain.</div>
          </div>
          <div>
            <label>Selected</label>
            <div class="pill" id="methodPill">GET</div>
            <div class="hint" id="opHint"></div>
          </div>
        </div>

        <div id="paramsPanel" class="grid two"></div>
        <div id="bodyPanel" class="grid two"></div>

        <div class="row">
          <button id="sendBtn">Send Request</button>
        </div>

        <div class="grid two">
          <div>
            <h3 class="section-title">Response</h3>
            <div class="response-meta" id="respMeta">Not sent</div>
            <pre id="responseBox">Awaiting request...</pre>
          </div>
          <div>
            <h3 class="section-title">cURL</h3>
            <pre id="curlBox"></pre>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    const state = { ops: [], current: null };

    function defaultBaseUrl() {
      try {
        const u = new URL(location.href);
        return `${u.protocol}//${u.hostname}:10001/douyin`;
      } catch (_) {
        return "http://47.243.155.129/douyin";
      }
    }

    function trimTrailingSlash(str) {
      if (!str) return str;
      return str.endsWith("/") ? str.slice(0, -1) : str;
    }

    function labelFrom(op) {
      const path = (op.path || "").toLowerCase();
      const summary = (op.summary || "").toLowerCase();
      const match = (keyword, label) => (path.includes(keyword) || summary.includes(keyword));
      if (match("/user/register", "register")) return "Register";
      if (match("/user/login", "login")) return "Login";
      if (match("/user", "user")) return "User Info";
      if (match("/relation/follower", "follower")) return "Follower List";
      if (match("/relation/follow", "follow")) return "Follow List";
      if (match("/relation/friend", "friend")) return "Friends";
      if (match("/relation/action", "follow")) return "Follow";
      if (match("/favorite/action", "favorite")) return "Like";
      if (match("/favorite/list", "favorite")) return "User's Likes";
      if (match("/comment/action", "comment")) return "Comment";
      if (match("/comment/list", "comment")) return "Video Comments";
      if (match("/message/chat", "chat")) return "Chat";
      if (match("/message/action", "message")) return "Messages";
      if (match("/feed", "feed")) return "Feed";
      if (match("/publish/action", "publish")) return "Publish";
      if (match("/publish/list", "publish")) return "Feeds";
      const fallback = summary || path || "Api";
      const clean = fallback.replace(/[^a-zA-Z0-9]/g, " ").trim().split(/\s+/)[0] || "Api";
      return clean.charAt(0).toUpperCase() + clean.slice(1).toLowerCase();
    }

    async function loadOpenAPI() {
      const responseBox = document.getElementById("responseBox");
      try {
        const res = await fetch("tiktok.openapi.json", { cache: "no-cache" });
        if (!res.ok) throw new Error("fetch failed: " + res.status);
        const api = await res.json();
        const baseFromServer = (api.servers && api.servers[0] && api.servers[0].url) || "";
        const suggestedBase = trimTrailingSlash(baseFromServer || defaultBaseUrl());
        document.getElementById("baseUrl").value = suggestedBase;

        const paths = api.paths || {};
        Object.keys(paths).forEach((path) => {
          const methods = paths[path] || {};
          Object.keys(methods).forEach((method) => {
            const detail = methods[method] || {};
            const bodyProps =
              detail.requestBody &&
              detail.requestBody.content &&
              detail.requestBody.content["multipart/form-data"] &&
              detail.requestBody.content["multipart/form-data"].schema &&
              detail.requestBody.content["multipart/form-data"].schema.properties
                ? detail.requestBody.content["multipart/form-data"].schema.properties
                : {};
            state.ops.push({
              id: `${method.toUpperCase()} ${path}`,
              method: method.toUpperCase(),
              path,
              summary: detail.summary || `${method.toUpperCase()} ${path}`,
              params: detail.parameters || [],
              bodyProps: bodyProps,
              label: labelFrom({ summary: detail.summary, path }),
            });
          });
        });
        renderOperations();
      } catch (err) {
        console.error("Load OpenAPI failed", err);
        responseBox.textContent = "Failed to load OpenAPI: " + err;
      }
    }

    function renderOperations() {
      const list = document.getElementById("operationList");
      list.innerHTML = "";
      state.ops.forEach((op, idx) => {
        const item = document.createElement("div");
        item.className = "nav-item";
        item.textContent = op.label || op.summary || op.path;
        item.dataset.idx = idx;
        item.addEventListener("click", () => {
          onOperationChange(idx);
        });
        list.appendChild(item);
      });
      if (state.ops.length) onOperationChange(0);
      list.addEventListener("click", (e) => {
        if (e.target.dataset.idx !== undefined) {
          document.querySelectorAll(".nav-item").forEach(el => el.classList.remove("active"));
          e.target.classList.add("active");
        }
      });
      if (list.firstChild) list.firstChild.classList.add("active");
    }

    function onOperationChange(idx) {
      state.current = state.ops[idx || 0];
      document.getElementById("methodPill").textContent = state.current.method;
      document.getElementById("opHint").textContent = state.current.summary;
      renderParams();
      renderBody();
      updateCurl();
    }

    function renderParams() {
      const panel = document.getElementById("paramsPanel");
      panel.innerHTML = "";
      const params = (state.current && state.current.params ? state.current.params : []).filter(function (p) { return p.in === "query"; });
      if (!params.length) {
        panel.innerHTML = '<div class="muted">No query params.</div>';
        return;
      }
      params.forEach(p => {
        const wrap = document.createElement("div");
        wrap.className = "field";
        wrap.innerHTML = `
          <label>${p.name}${p.required ? " *" : ""}</label>
          <input data-kind="query" data-name="${p.name}" placeholder="${p.description || ""}" value="${p.example || ""}">
          <div class="hint">${p.description || ""}</div>
        `;
        panel.appendChild(wrap);
      });
    }

    function renderBody() {
      const panel = document.getElementById("bodyPanel");
      panel.innerHTML = "";
      const props = (state.current && state.current.bodyProps) || {};
      const entries = Object.entries(props);
      if (!entries.length) {
        panel.innerHTML = '<div class="muted">No form params.</div>';
        return;
      }
      entries.forEach(([name, meta]) => {
        const isFile = meta.format === "binary";
        const wrap = document.createElement("div");
        wrap.className = "field";
        wrap.innerHTML = `
          <label>${name}${meta.description ? " — " + meta.description : ""}</label>
          ${isFile ? `<input type="file" data-kind="body" data-name="${name}">` :
            `<input data-kind="body" data-name="${name}" placeholder="${meta.description || ""}" value="${meta.example || ""}">`}
        `;
        panel.appendChild(wrap);
      });
    }

    async function sendRequest() {
      if (!state.current) return;
      const base = trimTrailingSlash(document.getElementById("baseUrl").value);
      const urlObj = new URL(base + state.current.path + (state.current.path.endsWith("/") ? "" : "/"));
      const method = state.current.method;

      document.querySelectorAll('input[data-kind="query"]').forEach(input => {
        if (input.value !== "") urlObj.searchParams.set(input.dataset.name, input.value);
      });

      const options = { method };
      const bodyProps = state.current ? (state.current.bodyProps || {}) : {};
      const hasBody = Object.keys(bodyProps).length > 0 && method !== "GET";
      if (hasBody) {
        const fd = new FormData();
        document.querySelectorAll('input[data-kind="body"]').forEach(input => {
          if (input.type === "file") {
            if (input.files[0]) fd.append(input.dataset.name, input.files[0]);
          } else if (input.value !== "") {
            fd.append(input.dataset.name, input.value);
          }
        });
        options.body = fd;
      }

      const start = performance.now();
      let statusText = "";
      let bodyText = "";
      try {
        const res = await fetch(urlObj.toString(), options);
        statusText = `${res.status} ${res.statusText}`;
        bodyText = await res.text();
      } catch (err) {
        statusText = "请求失败";
        bodyText = err.message || String(err);
      }
      const duration = (performance.now() - start).toFixed(0);
      document.getElementById("respMeta").textContent = `${statusText} · ${duration}ms`;
      document.getElementById("responseBox").textContent = formatJson(bodyText);
      updateCurl(urlObj.toString(), hasBody);
    }

    function formatJson(text) {
      try {
        return JSON.stringify(JSON.parse(text), null, 2);
      } catch (e) {
        return text;
      }
    }

    function updateCurl(url = "", hasBody = false) {
      if (!state.current) return;
      const base = trimTrailingSlash(document.getElementById("baseUrl").value);
      const baseUrlForCurl = base + state.current.path + (state.current.path.endsWith("/") ? "" : "/");
      const urlObj = url ? new URL(url) : new URL(baseUrlForCurl);
      const queryParts = [];
      document.querySelectorAll('input[data-kind="query"]').forEach(input => {
        if (input.value !== "") queryParts.push(`${encodeURIComponent(input.dataset.name)}=${encodeURIComponent(input.value)}`);
      });
      if (queryParts.length && !url) {
        urlObj.search = queryParts.join("&");
      }
      const lines = [`curl -X ${state.current.method} "${urlObj.toString()}"`];
      if (hasBody) {
        document.querySelectorAll('input[data-kind="body"]').forEach(input => {
          if (input.type === "file") {
            if (input.files[0]) lines.push(`  -F "${input.dataset.name}=@${input.files[0].name}"`);
          } else if (input.value !== "") {
            lines.push(`  -F "${input.dataset.name}=${input.value}"`);
          }
        });
      }
      document.getElementById("curlBox").textContent = lines.join(" \\\n");
    }

    document.getElementById("sendBtn").addEventListener("click", sendRequest);
    loadOpenAPI().catch(err => {
      document.getElementById("responseBox").textContent = "Failed to load OpenAPI: " + err;
    });
  </script>
</body>
</html>
